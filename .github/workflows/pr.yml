name: Execute Tests on PR
on:
  push:
  pull_request:
    branches: [main]

jobs:
  runUnitTest:
    name: Execute Unit/Widget tests

    runs-on: macos-latest

    strategy:
      matrix:
        flutter-version: ['3.27.2', '3.32.5']
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Install Melos
        run: dart pub global activate melos

      # - name: Lint
      #   run: melos exec -- "dart format --output=none --set-exit-if-changed ."

      - name: Pub Upgrade
        run: melos bootstrap

#      - name: Run Unit Tests / Widget Tests
#        run: melos exec -- "flutter test"

      - name: Run Auth Tests
        run: |
          cd modules/auth
          flutter test

  buildStarter:
    name: Build Starter App
    needs: runUnitTest
    runs-on: macos-latest

    strategy:
      matrix:
        flutter-version: ['3.27.2', '3.32.5']
        platform: ['web', 'android', 'ios']

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Setup Xcode (iOS only)
        if: matrix.platform == 'ios'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods (iOS only)
        if: matrix.platform == 'ios'
        run: |
          sudo gem install cocoapods
          cd starter/ios
          pod repo update
          pod install

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap Melos
        run: melos bootstrap

      - name: Build for ${{ matrix.platform }}
        run: |
          cd starter
          case "${{ matrix.platform }}" in
            web)
              flutter build web --release --no-tree-shake-icons
              ;;
            android)
              flutter build apk --release --no-tree-shake-icons
              ;;
            ios)
              flutter build ios --release --no-codesign --no-tree-shake-icons
              ;;
          esac

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: starter-build-${{ matrix.platform }}-flutter-${{ matrix.flutter-version }}
          path: |
            starter/build/web/**
            starter/build/app/outputs/flutter-apk/*.apk
            starter/build/ios/Release-iphoneos/Runner.app/**
          retention-days: 7
